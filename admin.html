<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Rservas.Roma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://resource.trickle.so/vendor_lib/unpkg/react@18/umd/react.production.min.js"></script>
    <script src="https://resource.trickle.so/vendor_lib/unpkg/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://resource.trickle.so/vendor_lib/unpkg/@babel/standalone/babel.min.js"></script>
    <link href="https://resource.trickle.so/vendor_lib/unpkg/lucide-static@0.516.0/font/lucide.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Scripts con rutas relativas y timestamp -->
    <script type="text/javascript" src="utils/supabase-config.js?v=202402261530"></script>
    <script type="text/javascript" src="utils/storage.js?v=202402261530"></script>

    <script type="text/javascript">
        console.log('üîç VERIFICACI√ìN INICIAL ADMIN:');
        console.log('  window.SUPABASE_URL:', window.SUPABASE_URL);
        console.log('  window.SUPABASE_ANON_KEY:', window.SUPABASE_ANON_KEY ? '‚úì Definida' : '‚úó Undefined');
        console.log('  location.pathname:', window.location.pathname);
        console.log('  location.origin:', window.location.origin);
        
        if (!window.SUPABASE_URL) {
            console.error('‚ùå ERROR CR√çTICO: SUPABASE_URL no est√° definida en admin.html');
        } else {
            console.log('‚úÖ Supabase configurado correctamente en admin.html');
        }
    </script>

    <script type="text/javascript" src="utils/api.js?v=202402261530"></script>
    <script type="text/javascript" src="utils/timeLogic.js?v=202402261530"></script>
    <script type="text/javascript" src="utils/auth-clients.js?v=202402261530"></script>
    <script type="text/javascript" src="utils/auth-barberos.js?v=202402261530"></script>
    <script type="text/javascript" src="utils/config.js?v=202402261530"></script>
    <script type="text/javascript" src="utils/servicios.js?v=202402261530"></script>
    <script type="text/javascript" src="utils/barberos.js?v=202402261530"></script>

    <script type="text/javascript">
        console.log('üîç VERIFICACI√ìN DE CARGA ADMIN:');
        console.log(' ‚úÖ supabase-config:', window.SUPABASE_URL ? 'OK' : 'FALTA');
        console.log(' ‚úÖ SUPABASE_URL:', window.SUPABASE_URL);
        console.log(' ‚úÖ auth-barberos:', typeof window.verificarBarberoPorTelefono);
        console.log(' ‚úÖ auth-clientes:', typeof window.verificarAccesoCliente);
        console.log(' ‚úÖ salonConfig:', typeof window.salonConfig);
        console.log(' ‚úÖ salonServicios:', typeof window.salonServicios);
        console.log(' ‚úÖ salonBarberos:', typeof window.salonBarberos);
        console.log(' ‚úÖ storage:', typeof window.subirImagenServicio);
    </script>

    <script type="text/babel" src="components/admin/ConfigPanel.js?v=202402261530"></script>
    <script type="text/babel" src="components/admin/ServiciosPanel.js?v=202402261530"></script>
    <script type="text/babel" src="components/admin/BarberosPanel.js?v=202402261530"></script>
    <script type="text/babel" src="components/admin/HorariosPorDiaPanel.js?v=202402261530"></script>
    <script type="text/babel" src="admin-app.js?v=202402261530"></script>

    <script>
        (function() {
            const isAdmin = localStorage.getItem('adminAuth') === 'true';
            const barberoAuth = localStorage.getItem('barberoAuth');
            
            console.log('üîê Verificando autenticaci√≥n:', { isAdmin, barberoAuth: !!barberoAuth });
            console.log('üîê SUPABASE_URL en auth:', window.SUPABASE_URL);
            
            if (isAdmin) {
                const loginTime = localStorage.getItem('adminLoginTime');
                const isValidSession = loginTime && (Date.now() - parseInt(loginTime)) < 8 * 60 * 60 * 1000;
                
                if (!isValidSession) {
                    localStorage.removeItem('adminAuth');
                    localStorage.removeItem('adminUser');
                    localStorage.removeItem('adminLoginTime');
                    window.location.href = 'admin-login.html';
                }
                return;
            }
            
            if (barberoAuth) {
                console.log('üë§ Acceso como barbero');
                return;
            }
            
            console.log('üö´ No hay sesi√≥n, redirigiendo a login');
            window.location.href = 'admin-login.html';
        })();
    </script>

    <!-- Sistema de actualizaciones para admin -->
    <script>
        let swRegistration = null;
        let updateNotificationShown = false;

        function showUpdateNotification() {
            if (updateNotificationShown) return;
            
            const banner = document.createElement('div');
            banner.id = 'update-notification';
            banner.className = 'update-banner';
            banner.innerHTML = `
                <div class="banner-content">
                    <div class="banner-icon">‚úÇÔ∏è</div>
                    <div class="banner-text">
                        <div class="banner-title">¬°Nueva versi√≥n disponible!</div>
                        <div class="banner-subtitle">Actualizamos Rservas.Roma con mejoras</div>
                    </div>
                    <button onclick="updateApp()" class="banner-button">Actualizar ahora</button>
                </div>
            `;
            document.body.appendChild(banner);
            updateNotificationShown = true;
        }

        window.updateApp = () => {
            const notification = document.getElementById('update-notification');
            if (notification) notification.remove();
            
            if (swRegistration && swRegistration.waiting) {
                swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
            }
            
            const reloadMsg = document.createElement('div');
            reloadMsg.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-[10000]';
            reloadMsg.id = 'reload-message';
            reloadMsg.innerHTML = `
                <div class="bg-amber-600 text-white p-6 rounded-2xl shadow-2xl text-center max-w-xs mx-4">
                    <div class="animate-spin h-12 w-12 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
                    <h3 class="text-xl font-bold mb-2">Actualizando...</h3>
                    <p class="text-amber-100">El panel se recargar√° autom√°ticamente</p>
                </div>
            `;
            document.body.appendChild(reloadMsg);
            
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        };

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/Rservas.Roma/sw.js')
                    .then(registration => {
                        swRegistration = registration;
                        console.log('‚úÖ Service Worker registrado en admin');

                        if (registration.waiting) {
                            showUpdateNotification();
                        }

                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showUpdateNotification();
                                }
                            });
                        });
                    });

                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('üîÑ Service Worker cambiado, recargando admin...');
                    window.location.reload();
                });
            });

            setInterval(() => {
                if (swRegistration) {
                    swRegistration.update();
                }
            }, 30 * 60 * 1000);
        }
    </script>
</body>
</html>