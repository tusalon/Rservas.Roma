<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba - Rservas.Roma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">üîç PRUEBA DE CONEXI√ìN</h1>
        
        <div class="bg-white p-4 rounded-lg shadow mb-4">
            <h2 class="font-bold mb-2">üìä Negocios desde Supabase:</h2>
            <div id="resultado" class="text-sm text-gray-600">
                Cargando...
            </div>
        </div>

        <button 
            onclick="probarConexion()"
            class="bg-pink-600 text-white px-4 py-2 rounded-lg"
        >
            üîÑ Probar de nuevo
        </button>
    </div>

    <script type="text/javascript" src="utils/supabase-config.js"></script>
    <script>
        // ‚úÖ SOLO UNA VEZ - SIN 'const' DELANTE
        window.supabase = window.supabase.createClient(
            window.SUPABASE_URL,
            window.SUPABASE_ANON_KEY
        );

        async function probarConexion() {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = 'Consultando...';
            
            try {
                // 1. Verificar autenticaci√≥n
                const { data: { user }, error: authError } = await window.supabase.auth.getUser();
                
                let html = '<div class="space-y-4">';
                
                html += '<div class="border-b pb-2">';
                html += '<h3 class="font-bold text-green-600">‚úÖ USUARIO</h3>';
                if (user) {
                    html += `<p>Email: ${user.email}</p>`;
                    html += `<p>ID: ${user.id}</p>`;
                } else {
                    html += '<p class="text-red-600">‚ùå No hay usuario autenticado</p>';
                }
                html += '</div>';
                
                // 2. Obtener negocios
                const { data, error } = await window.supabase
                    .from('vista_negocios_admin')
                    .select('*')
                    .order('fecha_registro', { ascending: false });
                
                if (error) throw error;
                
                html += '<div class="border-b pb-2">';
                html += `<h3 class="font-bold text-blue-600">üìã NEGOCIOS (${data.length})</h3>`;
                
                data.forEach((neg, i) => {
                    html += `<div class="mt-2 p-2 bg-gray-50 rounded">`;
                    html += `<p><strong>${i+1}. ${neg.nombre}</strong></p>`;
                    html += `<p class="text-xs">Email: ${neg.email}</p>`;
                    html += `<p class="text-xs">Plan: ${neg.plan_actual} | Estado: ${neg.estado_suscripcion}</p>`;
                    html += `<p class="text-xs">ID: ${neg.id}</p>`;
                    html += `</div>`;
                });
                
                html += '</div>';
                
                // 3. Verificar suscripciones
                const { data: subs } = await window.supabase
                    .from('suscripciones')
                    .select('*');
                
                html += '<div>';
                html += `<h3 class="font-bold text-purple-600">üí∞ SUSCRIPCIONES (${subs?.length || 0})</h3>`;
                html += '</div>';
                
                html += '</div>';
                resultado.innerHTML = html;
                
            } catch (error) {
                resultado.innerHTML = `<p class="text-red-600">‚ùå ERROR: ${error.message}</p>`;
            }
        }

        window.onload = probarConexion;
    </script>
</body>
</html>